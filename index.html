<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EventDemo dApp (Fixed)</title>
  <link rel="icon" href="/favicon.ico" />

  <!-- Load ONLY ethers v5 (required by token.js) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

  <!-- Styles -->
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.4;margin:24px;background:#fafafa;color:#111}
    .card{background:white;padding:18px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.06);max-width:980px;margin:auto}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    button.primary{background:#2563eb;color:white;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .small{font-size:12px;color:#666}
    #events .evt{border-bottom:1px solid #eee;padding:8px 0}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
    label{display:block;font-size:13px;color:#333;margin-bottom:6px}
    input[type=text]{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
    .muted{color:#666;font-size:13px}
    pre{background:#f7f7f7;padding:8px;border-radius:6px}
  </style>
</head>

<body>
  <div class="card">
    <header>
      <div>
        <h2 style="margin:0">EventDemo dApp</h2>
        <div class="small">Simple demo showing event logs & message setter</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div id="walletStatus" class="small muted">Not connected</div>
        <!-- Put your contract address here; script will checksum/normalize it -->
        <div id="contractAddr" class="small muted">0xE3e7fc9b468519B911c114F377C6d45e21Ac4284</div>
      </div>
    </header>

    <div class="grid">
      <div>

        <div style="margin-bottom:12px">
          <button id="connectBtn" class="primary">Connect Wallet</button>
          <button id="refreshEvents" style="margin-left:8px">Refresh Events</button>
          <button id="clearEvents" style="margin-left:8px">Clear Events</button>
        </div>

        <div style="margin-bottom:12px">
          <button id="pingBtn">Send ping()</button>
          <button id="setMsgBtn" style="margin-left:8px">setMessage()</button>
          <input id="msgInput" type="text" placeholder="Message to set" style="display:inline-block;margin-left:8px;width:240px" value="yes Web3" />
        </div>

        <div style="margin-bottom:12px">
          <button id="readMsg">Refresh message</button>
          <div style="margin-top:8px">Current message: <span id="currentMessage" class="muted">(empty)</span></div>
        </div>

        <h3>Events</h3>
        <div id="events" style="min-height:120px;border:1px solid #eee;padding:10px;border-radius:8px;background:#fff;max-height:420px;overflow:auto"></div>

      </div>

      <aside>
        <h4>Debug / Notes</h4>
        <pre id="debug" style="height:220px;overflow:auto">Open DevTools → Console to see logs.</pre>
        <div style="margin-top:12px" class="small muted">Make sure MetaMask is unlocked and set to Sepolia (chainId 0xaa36a7).</div>
      </aside>
    </div>
  </div>

  <!-- Load token.js (your SIM Token helper). Must exist in same folder. -->
  <script src="token.js"></script>

  <!-- EventDemo app logic (uses ethers v5) -->
  <script>
  (async function(){
    // ABI & initial values
    const abi = [
      "event ActionLogged(address indexed user, string message, uint256 timestamp)",
      "function ping() public",
      "function setMessage(string _msg) public",
      "function message() public view returns (string)"
    ];

    // DOM elements
    const contractAddrEl = document.getElementById('contractAddr');
    let contractAddressRaw = (contractAddrEl && contractAddrEl.innerText) ? contractAddrEl.innerText.trim() : '';
    if (!contractAddressRaw) {
      console.error('No contract address found in #contractAddr');
      contractAddressRaw = '';
    }

    // Normalize & validate using ethers.utils.getAddress()
    let contractAddress;
    try {
      contractAddress = ethers.utils.getAddress(contractAddressRaw);
      contractAddrEl.innerText = contractAddress; // show checksummed
    } catch (err) {
      console.warn('Address checksum invalid or mixed-case. Falling back to lowercase and attempting to normalize. Original:', contractAddressRaw);
      const lower = contractAddressRaw.toLowerCase();
      try {
        contractAddress = ethers.utils.getAddress(lower);
        contractAddrEl.innerText = contractAddress;
      } catch (err2) {
        console.error('Address still invalid after lowercasing. Using lowercase string as-is:', err2);
        contractAddress = lower; // last resort
      }
    }

    let provider, signer, contract;

    const connectBtn = document.getElementById('connectBtn');
    const walletStatus = document.getElementById('walletStatus');
    const pingBtn = document.getElementById('pingBtn');
    const setMsgBtn = document.getElementById('setMsgBtn');
    const msgInput = document.getElementById('msgInput');
    const eventsDiv = document.getElementById('events');
    const readMsgBtn = document.getElementById('readMsg');
    const refreshEventsBtn = document.getElementById('refreshEvents');
    const clearEventsBtn = document.getElementById('clearEvents');
    const debugPre = document.getElementById('debug');

    function short(a){ return a ? (a.slice(0,6) + "..." + a.slice(-4)) : '(no addr)'; }
    function logDebug(...args){
      try{
        console.log(...args);
        debugPre.innerText += '\n' + args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');
        debugPre.scrollTop = debugPre.scrollHeight;
      }catch(e){}
    }

    function toast(msg){
      try{
        const t = document.createElement('div');
        t.style.position='fixed'; t.style.right='16px'; t.style.bottom='16px'; t.style.zIndex=999999;
        t.style.background='rgba(0,0,0,0.85)'; t.style.color='white'; t.style.padding='10px 12px'; t.style.borderRadius='8px';
        t.style.boxShadow='0 6px 18px rgba(0,0,0,0.2)'; t.textContent = msg; document.body.appendChild(t);
        setTimeout(()=> t.style.opacity='0',3500); setTimeout(()=> t.remove(),4200);
      }catch(e){}
    }

    function addEventObj(e){
      const el = document.createElement('div');
      el.className = 'evt';
      const time = new Date(Number(e.timestamp)*1000).toLocaleString();
      el.innerHTML = `<div><strong>${e.message}</strong></div><div class="small">by ${short(e.user)} • ${time}</div>`;
      eventsDiv.prepend(el);
    }

    async function attach(){
      if (!window.ethereum) throw new Error('MetaMask not found (window.ethereum missing).');
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      contract = new ethers.Contract(contractAddress, abi, signer);
      logDebug('attach: provider & contract ready', contractAddress);
    }

    async function connectWallet(){
      try{
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        await attach();
        walletStatus.innerText = 'Connected: ' + short(accounts[0]);
        connectBtn.innerText = 'Connected';
        connectBtn.disabled = true;
        await readCurrentMessage();
        await fetchPastEvents();
        listenEvents();
        logDebug('Connected', accounts[0]);
      } catch(e){
        console.error('connectWallet error ->', e);
        logDebug('connectWallet error ->', e.message || e);
        toast('MetaMask connection failed (see console)');
      }
    }

    async function sendPing(){
      try{
        const tx = await contract.ping();
        const receipt = await tx.wait();
        toast('Ping tx: ' + receipt.transactionHash);
        logDebug('ping tx', receipt.transactionHash);
      }catch(e){
        console.error('sendPing error ->', e);
        toast('Ping failed (see console)');
      }
    }

    async function doSetMessage(){
      const txt = msgInput.value.trim();
      if(!txt){ toast('Enter a message first!'); return; }
      try{
        const tx = await contract.setMessage(txt);
        const receipt = await tx.wait();
        toast('setMessage tx: ' + receipt.transactionHash);
        msgInput.value = '';
        await readCurrentMessage();
        logDebug('setMessage tx', receipt.transactionHash);
      }catch(e){
        console.error('doSetMessage error ->', e);
        if (e && e.code === 'INVALID_ARGUMENT' && /checksum/i.test(String(e.message))) {
          toast('Contract address checksum invalid - see console');
        } else {
          toast('setMessage failed (see console)');
        }
      }
    }

    async function readCurrentMessage(){
      try{
        const m = await contract.message();
        document.getElementById('currentMessage').innerText = m || '(empty)';
      }catch(e){
        console.error('readCurrentMessage error ->', e);
        toast('Read message failed (see console)');
      }
    }

    async function fetchPastEvents(){
      try{
        const iface = new ethers.utils.Interface(abi);
        const topic = iface.getEventTopic('ActionLogged');
        const filter = { address: contractAddress, topics: [topic] };
        const logs = await provider.getLogs(filter);
        for(const log of logs.reverse()){
          const parsed = iface.parseLog(log);
          addEventObj({ user: parsed.args.user, message: parsed.args.message, timestamp: parsed.args.timestamp.toString() });
        }
      }catch(e){
        console.error('fetchPastEvents error ->', e);
        toast('Fetching events failed (see console)');
      }
    }

    function listenEvents(){
      try {
        contract.on('ActionLogged', (user, message, timestamp) => {
          addEventObj({ user, message, timestamp: timestamp.toString() });
        });
      } catch (e) {
        console.error('listenEvents error ->', e);
      }
    }

    // wire up buttons
    connectBtn.onclick = connectWallet;
    pingBtn.onclick = sendPing;
    setMsgBtn.onclick = doSetMessage;
    readMsgBtn.onclick = readCurrentMessage;
    refreshEventsBtn.onclick = () => { eventsDiv.innerHTML = ''; fetchPastEvents(); };
    clearEventsBtn.onclick = () => { eventsDiv.innerHTML = ''; };

    // attempt silent attach if already connected
    if (window.ethereum && window.ethereum.selectedAddress) {
      try {
        await attach();
        walletStatus.innerText = 'Connected (silent): ' + short(window.ethereum.selectedAddress);
        connectBtn.innerText = 'Connected';
        connectBtn.disabled = true;
        await readCurrentMessage();
        fetchPastEvents();
        listenEvents();
        logDebug('Auto-attached to provider', window.ethereum.selectedAddress);
      } catch (e) {
        // ignore
      }
    }

  })();
  </script>
</body>
</html>
